<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clear localStorage and Test New Project</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            background: #f9fafb;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 {
            color: #111827;
            margin-bottom: 30px;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 14px;
        }
        button:hover {
            background: #2563eb;
        }
        button.danger {
            background: #ef4444;
        }
        button.danger:hover {
            background: #dc2626;
        }
        button.success {
            background: #10b981;
        }
        button.success:hover {
            background: #059669;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
        }
        .success {
            background: #d1fae5;
            border-color: #6ee7b7;
            color: #065f46;
        }
        .error {
            background: #fee2e2;
            border-color: #fca5a5;
            color: #991b1b;
        }
        .warning {
            background: #fef3c7;
            border-color: #fbbf24;
            color: #92400e;
        }
        pre {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.5;
        }
        .section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e5e7eb;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .card {
            padding: 20px;
            background: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        .card h3 {
            margin-top: 0;
            color: #374151;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Clear localStorage and Test New Project Creation</h1>
        
        <div>
            <button onclick="analyzeCurrentState()">üìä Analyze Current State</button>
            <button onclick="clearAllData()" class="danger">üóëÔ∏è Clear ALL localStorage Data</button>
            <button onclick="createTestProject()" class="success">‚ú® Create Clean Test Project</button>
            <button onclick="validateProjectIsolation()">üîç Validate Project Isolation</button>
        </div>

        <div id="status" class="status">
            Ready to clear data and test clean project creation.
        </div>

        <div class="section">
            <h2>Current localStorage Analysis</h2>
            <div id="analysis"></div>
        </div>

        <div class="section">
            <h2>Test Results</h2>
            <div id="results"></div>
        </div>
    </div>

    <script>
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.innerHTML = message;
        }

        function analyzeCurrentState() {
            const analysis = document.getElementById('analysis');
            let html = '<div class="grid">';
            
            // Analyze princess_data
            const princessData = localStorage.getItem('princess_data');
            if (princessData) {
                try {
                    const data = JSON.parse(princessData);
                    html += `
                        <div class="card">
                            <h3>princess_data</h3>
                            <p>Projects: ${data.projects?.length || 0}</p>
                            <p>Stages: ${data.stages?.length || 0}</p>
                            <p>Deliverables: ${data.deliverables?.length || 0}</p>
                            <p>Team Members: ${data.teamMembers?.length || 0}</p>
                        </div>
                    `;
                    
                    // Show project names
                    if (data.projects?.length > 0) {
                        html += `
                            <div class="card">
                                <h3>Projects Found</h3>
                                <ul>
                                    ${data.projects.map(p => `<li>${p.name} (${p.id})</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Check for contamination
                    const stagesByProject = {};
                    if (data.stages) {
                        data.stages.forEach(stage => {
                            const pid = stage.project_id || 'no_project';
                            stagesByProject[pid] = (stagesByProject[pid] || 0) + 1;
                        });
                    }
                    
                    html += `
                        <div class="card">
                            <h3>Stages by Project</h3>
                            <ul>
                                ${Object.entries(stagesByProject).map(([pid, count]) => 
                                    `<li>${pid}: ${count} stages</li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                    
                } catch (e) {
                    html += `<div class="card error">Error parsing princess_data: ${e.message}</div>`;
                }
            } else {
                html += '<div class="card">No princess_data found in localStorage</div>';
            }
            
            // Check for other suspicious keys
            const suspiciousKeys = [];
            for (let key of Object.keys(localStorage)) {
                if (key.includes('project') || key.includes('stage') || key.includes('deliverable')) {
                    suspiciousKeys.push(key);
                }
            }
            
            if (suspiciousKeys.length > 0) {
                html += `
                    <div class="card">
                        <h3>Other Relevant Keys</h3>
                        <ul>
                            ${suspiciousKeys.map(key => `<li>${key}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            html += '</div>';
            analysis.innerHTML = html;
            updateStatus('Analysis complete', 'success');
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è This will DELETE ALL localStorage data. Are you sure?')) {
                return;
            }
            
            // Clear everything
            localStorage.clear();
            
            // Verify it's empty
            const remaining = Object.keys(localStorage).length;
            if (remaining === 0) {
                updateStatus('‚úÖ ALL localStorage data has been cleared!', 'success');
                document.getElementById('analysis').innerHTML = '<p>localStorage is now completely empty.</p>';
                document.getElementById('results').innerHTML = '';
            } else {
                updateStatus(`‚ö†Ô∏è ${remaining} keys still remain in localStorage`, 'warning');
            }
        }

        function createTestProject() {
            const results = document.getElementById('results');
            
            // Create a test project structure
            const projectId = `project_${Date.now()}`;
            const testProject = {
                id: projectId,
                name: 'Clean Test Project',
                client_name: 'Test Client Corp',
                description: 'Testing clean project creation after fixes',
                start_date: new Date().toISOString(),
                status: 'active',
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            // Create empty data structure
            const cleanData = {
                projects: [testProject],
                stages: [], // No stages - should be added by the app
                deliverables: [],
                teamMembers: [],
                comments: [],
                notifications: [],
                outOfScopeRequests: []
            };
            
            // Save to localStorage
            localStorage.setItem('princess_data', JSON.stringify(cleanData));
            
            results.innerHTML = `
                <div class="card success">
                    <h3>‚úÖ Test Project Created</h3>
                    <p><strong>Project ID:</strong> ${projectId}</p>
                    <p><strong>Project Name:</strong> ${testProject.name}</p>
                    <p><strong>Client:</strong> ${testProject.client_name}</p>
                    <p><strong>Stages:</strong> 0 (app should clone from playbook)</p>
                    <p><strong>Deliverables:</strong> 0</p>
                    <br>
                    <p><strong>Next Steps:</strong></p>
                    <ol>
                        <li>Refresh the app (the page at localhost:5173)</li>
                        <li>You should see "Clean Test Project" with 0% progress</li>
                        <li>All stages should be gray (not_started)</li>
                        <li>No old data should appear</li>
                    </ol>
                </div>
            `;
            
            updateStatus('Test project created. Refresh the app to verify it works correctly.', 'success');
        }

        function validateProjectIsolation() {
            const results = document.getElementById('results');
            const princessData = localStorage.getItem('princess_data');
            
            if (!princessData) {
                results.innerHTML = '<div class="card error">No data found. Create a test project first.</div>';
                return;
            }
            
            const data = JSON.parse(princessData);
            const issues = [];
            const successes = [];
            
            // Check 1: All stages should have project_id
            const orphanStages = (data.stages || []).filter(s => !s.project_id);
            if (orphanStages.length > 0) {
                issues.push(`Found ${orphanStages.length} stages without project_id`);
            } else if (data.stages?.length > 0) {
                successes.push('All stages have project_id ‚úÖ');
            }
            
            // Check 2: All deliverables should have project_id
            const orphanDeliverables = (data.deliverables || []).filter(d => !d.project_id);
            if (orphanDeliverables.length > 0) {
                issues.push(`Found ${orphanDeliverables.length} deliverables without project_id`);
            } else if (data.deliverables?.length > 0) {
                successes.push('All deliverables have project_id ‚úÖ');
            }
            
            // Check 3: Check for cross-project contamination
            const projectIds = new Set((data.projects || []).map(p => p.id));
            const stageProjectIds = new Set((data.stages || []).map(s => s.project_id).filter(Boolean));
            const deliverableProjectIds = new Set((data.deliverables || []).map(d => d.project_id).filter(Boolean));
            
            const unknownStageProjects = [...stageProjectIds].filter(id => !projectIds.has(id));
            const unknownDeliverableProjects = [...deliverableProjectIds].filter(id => !projectIds.has(id));
            
            if (unknownStageProjects.length > 0) {
                issues.push(`Stages reference non-existent projects: ${unknownStageProjects.join(', ')}`);
            } else if (stageProjectIds.size > 0) {
                successes.push('All stage project references are valid ‚úÖ');
            }
            
            if (unknownDeliverableProjects.length > 0) {
                issues.push(`Deliverables reference non-existent projects: ${unknownDeliverableProjects.join(', ')}`);
            } else if (deliverableProjectIds.size > 0) {
                successes.push('All deliverable project references are valid ‚úÖ');
            }
            
            // Check 4: New projects should start with not_started stages
            if (data.stages?.length > 0) {
                const nonNotStartedStages = data.stages.filter(s => s.status && s.status !== 'not_started' && s.status !== 'not_ready');
                if (nonNotStartedStages.length > 0) {
                    issues.push(`Found ${nonNotStartedStages.length} stages that are not in 'not_started' status`);
                } else {
                    successes.push('All stages are in not_started status ‚úÖ');
                }
            }
            
            // Display results
            let html = '<div class="grid">';
            
            if (successes.length > 0) {
                html += `
                    <div class="card success">
                        <h3>‚úÖ Validation Passed</h3>
                        <ul>
                            ${successes.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            if (issues.length > 0) {
                html += `
                    <div class="card error">
                        <h3>‚ùå Issues Found</h3>
                        <ul>
                            ${issues.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            html += '</div>';
            results.innerHTML = html;
            
            if (issues.length === 0) {
                updateStatus('‚úÖ Project isolation is working correctly!', 'success');
            } else {
                updateStatus(`‚ö†Ô∏è Found ${issues.length} isolation issues`, 'error');
            }
        }

        // Run analysis on load
        window.onload = () => {
            analyzeCurrentState();
        };
    </script>
</body>
</html>